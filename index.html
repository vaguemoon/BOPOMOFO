<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ³¨éŸ³ç¬¦è™Ÿå–®éŸ³ï½œç²¾ç†Ÿç·´ç¿’</title>
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --sub:#475569; --border:#e2e8f0;
      --soft:#f1f5f9; --btn:#0f172a; --btnText:#fff; --ghostBg:#fff; --ghostText:#0f172a; --ghostBorder:#e2e8f0;
      --ok:#10b981; --bad:#ef4444;
    }
    [data-theme="dark"]{
      --bg:#020617; --card:#0f172a; --text:#f8fafc; --sub:#cbd5e1; --border:#334155;
      --soft:#1e293b; --btn:#34d399; --btnText:#020617; --ghostBg:#0f172a; --ghostText:#f8fafc; --ghostBorder:#334155;
      --ok:#34d399; --bad:#fb7185;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans TC","Segoe UI",Roboto,Arial; background:var(--bg); color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .space{height:10px}
    .title{font-size:20px;font-weight:900;letter-spacing:-0.02em}
    .subtitle{color:var(--sub);font-weight:700;font-size:13px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:0 1px 0 rgba(0,0,0,.03)}

    .btn{border:0;border-radius:18px;padding:12px 16px;font-weight:900;font-size:16px;cursor:pointer}
    .btnPrimary{background:var(--btn);color:var(--btnText)}
    .btnGhost{background:var(--ghostBg);color:var(--ghostText);border:1px solid var(--ghostBorder)}
    .btnIcon{padding:12px 14px;min-width:56px;font-size:22px;display:inline-flex;align-items:center;justify-content:center}
    .btn:active{transform:scale(.99)}
    .tabs .btn{min-width:92px}

    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.grid2{grid-template-columns:1fr 1fr}}

    .symGrid{display:flex;flex-wrap:wrap;gap:8px}
    .symBtn{border-radius:16px;border:1px solid var(--border);background:var(--card);padding:10px 14px;font-size:20px;font-weight:900;cursor:pointer}
    .symBtn.on{background:var(--text);color:var(--bg);border-color:var(--text)}
    [data-theme="dark"] .symBtn.on{background:var(--ok);color:#020617;border-color:var(--ok)}

    .hint{color:var(--sub);font-weight:800;font-size:12px}

    .canvasBox{display:flex;flex-direction:column;align-items:center;gap:10px}
    canvas{border-radius:18px;border:1px solid var(--border);background:#fff;touch-action:none}

    .resultBox{width:100%;max-width:360px;border-radius:18px;border:1px solid var(--border);padding:12px;background:var(--card)}
    .resultText{margin-top:8px;font-size:26px;font-weight:1000}
    .ok{color:var(--ok)} .bad{color:var(--bad)}

    .qOpts{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(min-width:640px){.qOpts{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:980px){.qOpts{grid-template-columns:repeat(4,1fr)}}
    .opt{border-radius:18px;border:1px solid var(--border);background:var(--card);padding:18px 10px;font-size:52px;font-weight:1000;cursor:pointer}
    .opt.dim{opacity:.6}
    .opt.ok{border-color:var(--ok);background:color-mix(in srgb, var(--ok) 12%, var(--card))}
    .opt.bad{border-color:var(--bad);background:color-mix(in srgb, var(--bad) 10%, var(--card))}

    select,input{width:100%;border-radius:14px;border:1px solid var(--border);padding:10px 10px;font-size:16px;font-weight:900;background:var(--bg);color:var(--text);outline:none}

    /* è®“å­¸ç”Ÿè³‡æ–™æ›´å° */
    .studentBar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .studentBar .mini{min-width:120px;flex:0 0 auto}
    .studentBar .name{min-width:160px;flex:1 1 160px}
    .label{font-size:12px;font-weight:900;color:var(--sub);margin-bottom:4px}

    /* æ¸¬é©—ï¼šæ›´å¤§æ›´å°‘çš„å…ƒç´  */
    .quizTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .quizOnly{max-width:980px;margin:0 auto}

    /* ===== ç©©å®šç‰ˆï¼šé–‹å§‹éŠæˆ²å¤§æŒ‰éˆ• ===== */
    .btnStartGame{padding:18px 22px;border-radius:26px;min-width:160px;font-size:22px;display:inline-flex;align-items:center;justify-content:center;gap:10px}
    .btnStartGame .icon{font-size:30px;line-height:1}
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between;align-items:flex-end">
    <div>
      <div class="title">æ³¨éŸ³ç¬¦è™Ÿå–®éŸ³ï½œç²¾ç†Ÿç·´ç¿’</div>
      <div class="subtitle">å­¸ç¿’ï¼ˆé»æ³¨éŸ³å°±ç™¼éŸ³ï¼‰ï½œæ¸¬é©—ï¼ˆé¸å° + æå¯«é€šéæ‰å¾—åˆ†ï¼‰</div>
    </div>
    <div class="row" style="align-items:center">
      <button id="themeBtn" class="btn btnGhost">ğŸŒ™</button>
    </div>
  </div>

  <div class="space"></div>

  <div class="row tabs">
    <button class="btn btnPrimary" id="tabLearn">å­¸ç¿’</button>
    <button class="btn btnGhost" id="tabQuiz">æ¸¬é©—</button>
    <button class="btn btnGhost" id="tabTeacher">æ•™å¸«</button>
  </div>

  <div class="space"></div>

  <!-- STUDENT (ç¸®å°) -->
  <div class="card">
    <div class="studentBar">
      <div class="mini">
        <div class="label">ç­ç´š</div>
        <select id="studentClass" aria-label="ç­ç´š">
          <option value="">â€”</option>
        </select>
      </div>
      <div class="mini">
        <div class="label">åº§è™Ÿ</div>
        <select id="studentSeat" aria-label="åº§è™Ÿ">
          <option value="">â€”</option>
        </select>
      </div>
      <div class="name">
        <div class="label">å§“åï¼ˆå¯ä¸å¡«ï¼‰</div>
        <input id="studentName" placeholder="" maxlength="20" />
      </div>
      <div class="mini" style="display:flex;align-items:flex-end">
        <button id="btnClearStudent" class="btn btnGhost" title="æ¸…é™¤">ğŸ§¹</button>
      </div>
    </div>
    <div class="hint" id="studentHint" style="margin-top:6px"></div>
  </div>

  <div class="space"></div>

  <!-- LEARN -->
  <section id="pageLearn" class="grid2">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div style="font-weight:1000">é»æ³¨éŸ³å°±æœƒç™¼éŸ³</div>
        <button id="btnSpeakLearn" class="btn btnPrimary btnIcon" title="è½">ğŸ”Š</button>
      </div>
      <div class="space"></div>
      <div class="symGrid" id="symList"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div style="font-weight:1000">æå¯«ï¼ˆé€šé / æœªé€šéï¼‰</div>
        <div class="row">
          <button id="btnClearLearn" class="btn btnGhost btnIcon" title="æ¸…é™¤">ğŸ§½</button>
          <button id="btnGradeLearn" class="btn btnPrimary btnIcon" title="å®Œæˆ">âœ…</button>
        </div>
      </div>
      <div class="space"></div>
      <div class="canvasBox">
        <canvas id="learnCanvas" width="320" height="320"></canvas>
        <div class="resultBox" aria-live="polite">
          <div id="learnResult" class="hint"> </div>
        </div>
      </div>
    </div>
  </section>

  <!-- QUIZ (ç›¡é‡åªç•™å­¸ç”Ÿè¦æ“ä½œçš„) -->
  <section id="pageQuiz" style="display:none">
    <div class="quizOnly">
      <div class="card">
        <div class="quizTop">
          <!-- âœ… ç©©å®šç‰ˆï¼šæ›´åƒéŠæˆ²çš„é–‹å§‹æŒ‰éˆ• -->
          <button id="btnStartQuiz" class="btn btnPrimary btnStartGame" title="é–‹å§‹">
            <span class="icon">ğŸ®</span><span>é–‹å§‹éŠæˆ²</span>
          </button>
          <div class="row">
            <button id="btnReplayQuiz" class="btn btnGhost btnIcon" title="å†è½ä¸€æ¬¡" disabled>ğŸ”Š</button>
            <button id="btnResetQuiz" class="btn btnGhost btnIcon" title="é‡ä¾†" style="display:none">ğŸ”„</button>
          </div>
        </div>

        <div class="space"></div>

        <div id="quizMain" class="grid2" style="display:none">
          <!-- äº¤é€šè™ŸèªŒé€²åº¦ç‡ˆ -->
          <div class="card" id="quizProgressCard" style="grid-column:1 / -1;text-align:center">
            <div id="quizLights" style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap"></div>
          </div>
          <div class="card" style="background:var(--soft)">
            <div class="qOpts" id="quizOpts"></div>
            <div class="space"></div>
            <div id="quizMsg" class="hint" style="text-align:center"></div>
          </div>

          <!-- æ­£ç¢ºå¾Œæ‰æœƒå‡ºç¾æå¯« -->
          <div class="card" id="quizTraceCard" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
              <div style="font-weight:1000">æå¯«é€šéæ‰å¾—åˆ†</div>
              <div class="row">
                <button id="btnClearQuizTrace" class="btn btnGhost btnIcon" title="æ¸…é™¤">ğŸ§½</button>
                <button id="btnGradeQuizTrace" class="btn btnPrimary btnIcon" title="å®Œæˆ">âœ…</button>
              </div>
            </div>
            <div class="space"></div>
            <div class="canvasBox">
              <canvas id="quizCanvas" width="320" height="320"></canvas>
              <div class="resultBox" aria-live="polite">
                <div id="quizTraceResult" class="hint"> </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- TEACHER -->
  <section id="pageTeacher" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:1000">æ•™å¸«è¨­å®šï¼ˆç²¾ç†Ÿæ¨™æº–ï¼‰</div>
          <div class="hint">è¨­å®šæœƒå„²å­˜åœ¨æ­¤è£ç½®</div>
        </div>
        <div class="row">
          <button id="btnAll" class="btn btnGhost">å…¨é¸</button>
          <button id="btnNone" class="btn btnGhost">å…¨ä¸é¸</button>
        </div>
      </div>

      <div class="space"></div>
      <div class="row">
        <div style="flex:1;min-width:180px">
          <div class="label">é¡Œæ•¸é–€æª»</div>
          <input id="setRQ" type="number" min="1" max="100" />
        </div>
        <div style="flex:1;min-width:180px">
          <div class="label">æ­£ç¢ºç‡é–€æª»ï¼ˆ%ï¼‰</div>
          <input id="setRA" type="number" min="1" max="100" />
        </div>
      </div>

      <div class="space"></div>
      <div class="row">
        <label class="hint" style="display:flex;align-items:center;gap:8px"><input id="setAutoSpeak" type="checkbox" /> æ¯é¡Œé–‹å§‹è‡ªå‹•æ’­ä¸€æ¬¡</label>
        <label class="hint" style="display:flex;align-items:center;gap:8px"><input id="setLock" type="checkbox" /> é¸å®Œé–å®šï¼ˆé¿å…é€£é»ï¼‰</label>
      </div>

      <div class="space"></div>
      <div class="hint" id="enabledCount">å·²é¸ç¬¦è™Ÿï¼š0</div>
      <div class="space"></div>
      <div class="symGrid" id="teacherSym"></div>

      <div class="space"></div>
      <div class="hint">çµæœå›å‚³ç«¯é»ï¼ˆ/execï¼‰ï¼š</div>
      <input id="endpointInput" placeholder="è²¼ä¸Š Apps Script /execï¼ˆå¯ç•™ç©ºï¼‰" />
      <div class="hint" style="margin-top:6px" id="epState"></div>
    </div>
  </section>

</div>

<script>
/** ====== CONFIG ====== **/
const K_STATS="bopomofo_stats_plain_v2";
const K_SETTINGS="bopomofo_teacher_plain_v2";
const K_STUDENT="bopomofo_student_plain_v2";
const K_THEME="bopomofo_theme_plain_v2";
const K_DEV="bopomofo_device_plain_v2";
const K_ENDPOINT="bopomofo_endpoint_plain_v1";

/** ====== DATA ====== **/
const BOPOMOFO = [
 "ã„…","ã„†","ã„‡","ã„ˆ","ã„‰","ã„Š","ã„‹","ã„Œ","ã„","ã„","ã„","ã„","ã„‘","ã„’","ã„“","ã„”","ã„•","ã„–","ã„—","ã„˜","ã„™",
 "ã„§","ã„¨","ã„©","ã„š","ã„›","ã„œ","ã„","ã„","ã„Ÿ","ã„ ","ã„¡","ã„¢","ã„£","ã„¤","ã„¥","ã„¦",
];

const DEFAULT_SETTINGS = {
  requiredQuestions: 10,
  requiredAccuracy: 80,
  enabledSymbols: BOPOMOFO.slice(),
  autoSpeakOnQuestion: true,
  lockAfterPick: true,
  // æå¯«åˆ¤å®šï¼ˆæ›´å¯¬é¬†ä¸€äº›ï¼Œè®“å­©å­æ¯”è¼ƒå®¹æ˜“éï¼‰
  tracePassScore: 52,
  traceToleranceStroke: 38,
  traceLineWidth: 22,
};

function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function percent(c,t){return t>0?Math.round((c/t)*100):0}
function nowIso(){return new Date().toISOString()}
function loadJSON(k,f){try{const r=localStorage.getItem(k);return r?JSON.parse(r):f}catch{return f}}
function saveJSON(k,v){localStorage.setItem(k,JSON.stringify(v))}

function getDeviceId(){
  var v=localStorage.getItem(K_DEV);
  if(v) return v;
  if (window.crypto && typeof window.crypto.randomUUID === "function") v = window.crypto.randomUUID();
  else v = "dev_" + Math.random().toString(16).slice(2);
  localStorage.setItem(K_DEV,v);
  return v;
}

function pickN(arr,n){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    const t=a[i]; a[i]=a[j]; a[j]=t;
  }
  return a.slice(0,n);
}
function pick4(pool,ans){
  const set=new Set([ans]);
  while(set.size<4) set.add(pool[Math.floor(Math.random()*pool.length)]);
  return pickN(Array.from(set),4);
}

/** ====== THEME ====== **/
function loadTheme(){
  const t=localStorage.getItem(K_THEME);
  if(t==="dark"||t==="light") return t;
  return (window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)?"dark":"light";
}
function setTheme(t){
  document.documentElement.dataset.theme=t;
  localStorage.setItem(K_THEME,t);
  themeBtn.textContent = (t==="dark") ? "â˜€ï¸" : "ğŸŒ™";
}

/** ====== VOICE ====== **/
let pickedVoice=null;
function pickVoice(){
  const synth=window.speechSynthesis;
  if(!synth) return;
  const voices=synth.getVoices()||[];
  const hints=["Yating","Ya-Ting","Mei-Jia","Google åœ‹èª","Google Chinese","Microsoft"];
  const candidates=voices
    .filter(v=>(v.lang||"").toLowerCase().indexOf("zh")>=0)
    .sort((a,b)=>{
      const aTW=(a.lang||"").toLowerCase().indexOf("tw")>=0?0:1;
      const bTW=(b.lang||"").toLowerCase().indexOf("tw")>=0?0:1;
      if(aTW!==bTW) return aTW-bTW;
      const as=hints.reduce((s,h)=>s+((a.name||"").indexOf(h)>=0?1:0),0);
      const bs=hints.reduce((s,h)=>s+((b.name||"").indexOf(h)>=0?1:0),0);
      return bs-as;
    });
  pickedVoice=candidates[0]||voices[0]||null;
}
function speak(text, kind){
  const synth=window.speechSynthesis;
  if(!synth) return;
  if(!pickedVoice) pickVoice();
  // âœ… ä¸å† cancelï¼šé¿å…èªéŸ³è¢«åˆ‡æ–·
  const u=new SpeechSynthesisUtterance(text);
  u.lang="zh-TW";
  if(pickedVoice) u.voice=pickedVoice;
  if(kind==="coach"){u.rate=0.9;u.pitch=1.15}else{u.rate=0.85;u.pitch=1.05}
  synth.speak(u);
}
function speakBopomofo(sym){speak(sym,"bopomofo")}
function speakCoach(msg){speak(msg,"coach")}

/** ====== POST RESULT ====== **/
function loadEndpoint(){
  return localStorage.getItem(K_ENDPOINT)||"";
}
function saveEndpoint(v){
  localStorage.setItem(K_ENDPOINT, (v||"").trim());
}
async function postResult(payload){
  const endpoint=loadEndpoint();
  if(!endpoint) return {ok:false,skipped:true};
  try{
    const res=await fetch(endpoint,{
      method:"POST",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body:JSON.stringify(payload),
    });
    return {ok:res.ok,status:res.status};
  }catch(e){return {ok:false,error:String(e)}}
}

/** ====== STATE ====== **/
let settings=loadJSON(K_SETTINGS, DEFAULT_SETTINGS);
settings.requiredQuestions=clamp(+settings.requiredQuestions||10,1,100);
settings.requiredAccuracy=clamp(+settings.requiredAccuracy||80,1,100);
settings.enabledSymbols=(Array.isArray(settings.enabledSymbols)&&settings.enabledSymbols.length)?settings.enabledSymbols.filter(x=>BOPOMOFO.indexOf(x)>=0):BOPOMOFO.slice();
settings.autoSpeakOnQuestion=!!settings.autoSpeakOnQuestion;
settings.lockAfterPick=!!settings.lockAfterPick;
settings.tracePassScore=clamp(+settings.tracePassScore||52,40,90);
settings.traceToleranceStroke=clamp(+settings.traceToleranceStroke||38,24,80);
settings.traceLineWidth=clamp(+settings.traceLineWidth||22,14,34);

let student=loadJSON(K_STUDENT,{classNo:"", seatNo:"", name:""});
let stats=loadJSON(K_STATS,{correct:0,total:0});
stats.correct=+stats.correct||0; stats.total=+stats.total||0;

let currentSymbol="ã„…";

/** ====== ELEMENTS ====== **/
const themeBtn=document.getElementById("themeBtn");
const tabLearn=document.getElementById("tabLearn");
const tabQuiz=document.getElementById("tabQuiz");
const tabTeacher=document.getElementById("tabTeacher");
const pageLearn=document.getElementById("pageLearn");
const pageQuiz=document.getElementById("pageQuiz");
const pageTeacher=document.getElementById("pageTeacher");

// student
const studentClass=document.getElementById("studentClass");
const studentSeat=document.getElementById("studentSeat");
const studentName=document.getElementById("studentName");
const btnClearStudent=document.getElementById("btnClearStudent");
const studentHint=document.getElementById("studentHint");

// learn
const symList=document.getElementById("symList");
const btnSpeakLearn=document.getElementById("btnSpeakLearn");
const learnCanvas=document.getElementById("learnCanvas");
const btnClearLearn=document.getElementById("btnClearLearn");
const btnGradeLearn=document.getElementById("btnGradeLearn");
const learnResult=document.getElementById("learnResult");

// quiz
const btnStartQuiz=document.getElementById("btnStartQuiz");
const btnReplayQuiz=document.getElementById("btnReplayQuiz");
const btnResetQuiz=document.getElementById("btnResetQuiz");
const quizMain=document.getElementById("quizMain");
const quizOpts=document.getElementById("quizOpts");
const quizMsg=document.getElementById("quizMsg");
const quizTraceCard=document.getElementById("quizTraceCard");
const quizCanvas=document.getElementById("quizCanvas");
const btnClearQuizTrace=document.getElementById("btnClearQuizTrace");
const btnGradeQuizTrace=document.getElementById("btnGradeQuizTrace");
const quizTraceResult=document.getElementById("quizTraceResult");

// teacher
const setRQ=document.getElementById("setRQ");
const setRA=document.getElementById("setRA");
const setAutoSpeak=document.getElementById("setAutoSpeak");
const setLock=document.getElementById("setLock");
const btnAll=document.getElementById("btnAll");
const btnNone=document.getElementById("btnNone");
const enabledCount=document.getElementById("enabledCount");
const teacherSym=document.getElementById("teacherSym");
const endpointInput=document.getElementById("endpointInput");
const epState=document.getElementById("epState");

/** ====== TABS ====== **/
function setTab(t){
  pageLearn.style.display = (t==="learn")?"grid":"none";
  pageQuiz.style.display = (t==="quiz")?"block":"none";
  pageTeacher.style.display = (t==="teacher")?"block":"none";

  tabLearn.className = "btn "+(t==="learn"?"btnPrimary":"btnGhost");
  tabQuiz.className = "btn "+(t==="quiz"?"btnPrimary":"btnGhost");
  tabTeacher.className = "btn "+(t==="teacher"?"btnPrimary":"btnGhost");
}

tabLearn.onclick=()=>setTab("learn");
tabQuiz.onclick=()=>setTab("quiz");
tabTeacher.onclick=()=>setTab("teacher");

/** ====== STUDENT UI (ä¸‹æ‹‰) ====== **/
function fillSelect(select, from, to){
  for(let i=from;i<=to;i++){
    const opt=document.createElement("option");
    opt.value=String(i);
    opt.textContent=String(i);
    select.appendChild(opt);
  }
}
fillSelect(studentClass,1,6);
fillSelect(studentSeat,1,25);

studentClass.value=student.classNo||"";
studentSeat.value=student.seatNo||"";
studentName.value=student.name||"";

function computedStudentId(){
  if(student.classNo && student.seatNo) return String(student.classNo).padStart(1,"0") + "-" + String(student.seatNo).padStart(2,"0");
  return "";
}
function updateStudentHint(){
  const sid=computedStudentId();
  if(sid) studentHint.textContent = "å·²é¸ï¼š" + sid + "ï¼ˆå¯å›å‚³çµæœï¼‰";
  else studentHint.textContent = "æœªé¸ç­ç´š/åº§è™Ÿï¼šä»å¯æ¸¬é©—ï¼Œä½†ä¸æœƒå›å‚³";
}
function saveStudent(){
  student.classNo = (studentClass.value||"").trim();
  student.seatNo  = (studentSeat.value||"").trim();
  student.name = (studentName.value||"").slice(0,20);
  saveJSON(K_STUDENT, student);
  updateStudentHint();
}
studentClass.addEventListener("change", saveStudent);
studentSeat.addEventListener("change", saveStudent);
studentName.addEventListener("input", saveStudent);
btnClearStudent.onclick=()=>{
  student={classNo:"", seatNo:"", name:""};
  saveJSON(K_STUDENT, student);
  studentClass.value="";
  studentSeat.value="";
  studentName.value="";
  updateStudentHint();
};

/** ====== TRACE PAD (å¯é‡ç”¨) ====== **/
function createTracePad(canvas, getSymbol, resultEl){
  const SIZE=320;
  const ctx=canvas.getContext("2d");
  let drawing=false;
  let last=null;

  function reset(){
    resultEl.className="hint";
    resultEl.textContent="";

    ctx.clearRect(0,0,SIZE,SIZE);
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,SIZE,SIZE);

    // grid
    ctx.strokeStyle="rgba(15,23,42,0.08)";
    ctx.lineWidth=1;
    for(let i=1;i<4;i++){
      const p=SIZE*i/4;
      ctx.beginPath(); ctx.moveTo(p,0); ctx.lineTo(p,SIZE); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(0,p); ctx.lineTo(SIZE,p); ctx.stroke();
    }

    // symbol guide
    const sym=getSymbol();
    ctx.fillStyle="rgba(15,23,42,0.18)";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.font="220px system-ui, -apple-system, 'Noto Sans TC', 'Segoe UI', Roboto, Arial";
    ctx.fillText(sym, SIZE/2, SIZE/2+10);

    ctx.strokeStyle="rgba(15,23,42,0.12)";
    ctx.lineWidth=2;
    ctx.strokeRect(8,8,SIZE-16,SIZE-16);
  }

  function posFromEvent(e){
    const r=canvas.getBoundingClientRect();
    const x=clamp(e.clientX-r.left,0,r.width);
    const y=clamp(e.clientY-r.top,0,r.height);
    return {x,y};
  }

  canvas.addEventListener("pointerdown",(e)=>{
    drawing=true;
    last=posFromEvent(e);
    canvas.setPointerCapture(e.pointerId);
  });
  canvas.addEventListener("pointermove",(e)=>{
    if(!drawing) return;
    const p=posFromEvent(e);
    if(!last){last=p;return;}
    ctx.strokeStyle="#ef4444";
    ctx.lineWidth=settings.traceLineWidth;
    ctx.lineCap="round";
    ctx.lineJoin="round";
    ctx.beginPath();
    ctx.moveTo(last.x,last.y);
    ctx.lineTo(p.x,p.y);
    ctx.stroke();
    last=p;
  });
  function endDraw(){drawing=false; last=null;}
  canvas.addEventListener("pointerup",endDraw);
  canvas.addEventListener("pointercancel",endDraw);

  function computePass(){
    const sym=getSymbol();

    // mask
    const mask=document.createElement("canvas");
    mask.width=SIZE; mask.height=SIZE;
    const m=mask.getContext("2d");
    m.fillStyle="#fff"; m.fillRect(0,0,SIZE,SIZE);
    m.fillStyle="#000";
    m.textAlign="center"; m.textBaseline="middle";
    m.font="220px system-ui, -apple-system, 'Noto Sans TC', 'Segoe UI', Roboto, Arial";
    m.fillText(sym, SIZE/2, SIZE/2+10);
    m.strokeStyle="#000";
    m.lineWidth=settings.traceToleranceStroke;
    m.strokeText(sym, SIZE/2, SIZE/2+10);

    const md=m.getImageData(0,0,SIZE,SIZE).data;
    const dd=ctx.getImageData(0,0,SIZE,SIZE).data;

    let targetArea=0, drawnTotal=0, hit=0, out=0;
    for(let i=0;i<md.length;i+=4){
      const isTarget = md[i+3]>10 && (md[i]<220 || md[i+1]<220 || md[i+2]<220);
      if(isTarget) targetArea++;

      const r=dd[i], g=dd[i+1], b=dd[i+2], a=dd[i+3];
      const isRed = a>0 && r>150 && g<180 && b<180;
      if(!isRed) continue;
      drawnTotal++;
      if(isTarget) hit++; else out++;
    }

    const coverage = targetArea? hit/targetArea : 0;
    const outside = drawnTotal? out/drawnTotal : 0;
    const raw = coverage*130 + 12 - outside*18;
    const score = clamp(Math.round(raw),0,100);
    const pass = score>=settings.tracePassScore;
    return {pass, score};
  }

  return { reset, computePass };
}

/** ====== LEARN ====== **/
function renderSymbolButtons(){
  symList.innerHTML="";
  BOPOMOFO.forEach(s=>{
    const b=document.createElement("button");
    b.className="symBtn"+(s===currentSymbol?" on":"");
    b.textContent=s;
    b.onclick=()=>{
      currentSymbol=s;
      speakBopomofo(s); // âœ… é»é¸å°±ç™¼éŸ³
      renderSymbolButtons();
      learnPad.reset();
    };
    symList.appendChild(b);
  });
}
btnSpeakLearn.onclick=()=>speakBopomofo(currentSymbol);

const learnPad=createTracePad(learnCanvas, ()=>currentSymbol, learnResult);
btnClearLearn.onclick=()=>learnPad.reset();
btnGradeLearn.onclick=()=>{
  const r=learnPad.computePass();
  if(r.pass){
    learnResult.className="resultText ok";
    learnResult.textContent="âœ… é€šé";
    speakCoach("ä½ é€šéäº†!");
  }else{
    learnResult.className="resultText bad";
    learnResult.textContent="âŒ æœªé€šé";
    speakCoach("æœªé€šéï¼Œå†è©¦è©¦çœ‹ã€‚");
  }
};

/** ====== TEACHER ====== **/
function saveSettings(){
  settings.requiredQuestions=clamp(+setRQ.value||10,1,100);
  settings.requiredAccuracy=clamp(+setRA.value||80,1,100);
  settings.autoSpeakOnQuestion=!!setAutoSpeak.checked;
  settings.lockAfterPick=!!setLock.checked;
  saveJSON(K_SETTINGS, settings);
  updateTeacherMeta();
}
function updateTeacherMeta(){
  enabledCount.textContent = "å·²é¸ç¬¦è™Ÿï¼š" + settings.enabledSymbols.length + " / " + BOPOMOFO.length;
  const ep=loadEndpoint();
  epState.textContent = ep ? "å·²è¨­å®šï¼š" + ep : "æœªè¨­å®šï¼ˆç©ºç™½ = ä¸å›å‚³ï¼‰";
}
function renderTeacherSymbols(){
  teacherSym.innerHTML="";
  BOPOMOFO.forEach(s=>{
    const on=settings.enabledSymbols.indexOf(s)>=0;
    const b=document.createElement("button");
    b.className="symBtn"+(on?" on":"");
    b.textContent=s;
    b.onclick=()=>{
      const set=new Set(settings.enabledSymbols);
      if(set.has(s)) set.delete(s); else set.add(s);
      settings.enabledSymbols=Array.from(set);
      saveJSON(K_SETTINGS, settings);
      renderTeacherSymbols();
      updateTeacherMeta();
    };
    teacherSym.appendChild(b);
  });
}
btnAll.onclick=()=>{settings.enabledSymbols=BOPOMOFO.slice(); saveJSON(K_SETTINGS,settings); renderTeacherSymbols(); updateTeacherMeta();};
btnNone.onclick=()=>{settings.enabledSymbols=[]; saveJSON(K_SETTINGS,settings); renderTeacherSymbols(); updateTeacherMeta();};

setRQ.value=settings.requiredQuestions;
setRA.value=settings.requiredAccuracy;
setAutoSpeak.checked=settings.autoSpeakOnQuestion;
setLock.checked=settings.lockAfterPick;
setRQ.oninput=saveSettings;
setRA.oninput=saveSettings;
setAutoSpeak.onchange=saveSettings;
setLock.onchange=saveSettings;

endpointInput.value=loadEndpoint();
endpointInput.addEventListener("input", ()=>{
  saveEndpoint(endpointInput.value);
  updateTeacherMeta();
});

/** ====== QUIZ (ä¸é¡¯ç¤ºå¤šé¤˜è³‡è¨Šã€ä¸å…è¨±ä¸‹ä¸€é¡ŒæŒ‰éˆ•) ====== **/

// ğŸš¦ äº¤é€šè™ŸèªŒé€²åº¦é¡¯ç¤º
const quizLights=document.getElementById("quizLights");
let quizResults=[]; // true=ç­”å°, false=ç­”éŒ¯
let quizRunning=false;
let levelIndex=0;
let levelCorrect=0;
let levelTotal=0;
let quizGoal="ã„…";
let quizLocked=false;
let quizNeedTrace=false;
let quizChosenOk=false;

// âœ… æ¯é¡Œè¨ˆåˆ†è¦å‰‡ï¼š
// - è‹¥æœ¬é¡Œæ›¾ç­”éŒ¯ä¸€æ¬¡ï¼šæ­¤é¡Œç®—ã€Œç­”éŒ¯ã€ï¼ˆtotal+1, correct+0ï¼‰ï¼Œä½†ä»å¿…é ˆé¸åˆ°æ­£ç¢ºä¸¦æå¯«é€šéæ‰èƒ½é€²ä¸‹ä¸€é¡Œ
// - è‹¥æœ¬é¡Œä¸€æ¬¡å°±é¸å°ï¼šæå¯«é€šéå¾Œæ‰ç®—ã€Œç­”å°ã€ï¼ˆtotal+1, correct+1ï¼‰
let quizQCounted=false;   // æœ¬é¡Œæ˜¯å¦å·²è¨ˆå…¥ total
let quizQWrong=false;     // æœ¬é¡Œæ˜¯å¦å·²åˆ¤å®šç‚ºç­”éŒ¯ï¼ˆæ›¾é¸éŒ¯ï¼‰

function enabledPool(){
  return (settings.enabledSymbols && settings.enabledSymbols.length)?settings.enabledSymbols:BOPOMOFO.slice();
}

function resetQuizUI(){
  quizRunning=false;
  quizMain.style.display="none";
  quizTraceCard.style.display="none";
  btnReplayQuiz.disabled=true;
  btnResetQuiz.style.display="none";
  quizMsg.textContent="";
  quizTraceResult.textContent="";
  quizTraceResult.className="hint";
  quizResults=[];
  renderQuizLights();
}

function currentLevelSymbol(){
  const pool=enabledPool();
  return pool[levelIndex] || pool[0] || "ã„…";
}

function startQuiz(){
  quizResults=[];
  renderQuizLights();
  const pool=enabledPool();
  if(pool.length===0){
    speakCoach("è€å¸«é‚„æ²’æœ‰é¸é¡Œåº«å–”ã€‚");
    setTab("teacher");
    return;
  }

  quizRunning=true;
  levelIndex=0; levelCorrect=0; levelTotal=0;
  quizMain.style.display="grid";
  btnReplayQuiz.disabled=false;
  btnResetQuiz.style.display="inline-flex";
  quizTraceCard.style.display="none";
  nextQuestion();
}

function nextQuestion(){
  quizLocked=false;
  quizNeedTrace=false;
  quizChosenOk=false;
  quizQCounted=false;
  quizQWrong=false;

  quizTraceCard.style.display="none";
  quizTraceResult.textContent="";
  quizTraceResult.className="hint";
  quizMsg.textContent="";

  // âœ… æ¯ä¸€é¡Œéƒ½éš¨æ©ŸæŠ½ä¸€å€‹æ³¨éŸ³ï¼ˆä¸å›ºå®šï¼‰
  const pool=enabledPool();
  quizGoal = pool[Math.floor(Math.random()*pool.length)];

  renderQuizOptions();

  // âœ… é¸é …æŒ‰éˆ•ä¸ç™¼éŸ³ï¼ˆé¿å…æ´©é¡Œï¼‰ï¼›åªåœ¨é¡Œç›®é–‹å§‹è‡ªå‹•æ’­ä¸€æ¬¡ï¼ˆè€å¸«å¯é—œï¼‰
  if(settings.autoSpeakOnQuestion){
    setTimeout(()=>speakBopomofo(quizGoal), 120);
  }
}

function renderQuizOptions(){
  const pool=enabledPool();
  const ops=pick4(pool, quizGoal);
  quizOpts.innerHTML="";
  ops.forEach(s=>{
    const b=document.createElement("button");
    b.className="opt";
    b.textContent=s;
    b.onclick=()=>pickAnswer(s);
    quizOpts.appendChild(b);
  });
}

function applyFeedbackUI(chosen){
  const children=Array.from(quizOpts.children);
  children.forEach(btn=>{
    const s=btn.textContent;
    btn.classList.remove("ok","bad","dim");
    if(s===quizGoal) btn.classList.add("ok");
    else if(s===chosen) btn.classList.add("bad");
    else btn.classList.add("dim");
  });
}

const quizPad=createTracePad(quizCanvas, ()=>quizGoal, quizTraceResult);

function pickAnswer(chosen){
  if(quizLocked) return;

  const ok=(chosen===quizGoal);
  applyFeedbackUI(chosen);

  // âœ… æ¸¬é©—ä¸­é»é¸é¸é …ä¸ç™¼éŸ³ï¼ˆé¿å…æ´©é¡Œï¼‰

  if(!ok){
    // âœ… ç­”éŒ¯ï¼šæ­¤é¡Œç«‹åˆ»ç®—ã€Œç­”éŒ¯ã€ï¼ˆåªç®—ä¸€æ¬¡ï¼‰ï¼Œä½†ä»ç•™åœ¨åŒä¸€é¡Œè®“å­©å­ç¹¼çºŒæ‰¾æ­£ç¢ºç­”æ¡ˆ
    if(!quizQCounted){
      levelTotal++;
      quizQCounted=true;
      quizQWrong=true;
    }
    // âŒ ä¸æ’­ã€Œæœªé€šéï¼Œå†è©¦è©¦çœ‹ã€èªéŸ³ï¼ˆåªç”¨é¡è‰²æç¤ºï¼‰
    quizMsg.textContent="";
    // é‡è¦ï¼šä¸è¦é–å®šï¼Œè®“å­©å­ç¹¼çºŒé»
    quizLocked=false;
    return;
  }

  // âœ… é¸å°ï¼šé€²å…¥æå¯«é—œå¡ï¼ˆé€šéæ‰å¯é€²ä¸‹ä¸€é¡Œï¼‰
  quizChosenOk=true;
  quizNeedTrace=true;
  quizTraceCard.style.display="block";
  quizPad.reset();

  // é¸å°å¾Œæ‰é–å®šé¸é …ï¼ˆé¿å…äº‚æŒ‰å›å»ï¼‰
  if(settings.lockAfterPick) quizLocked=true;

  speakCoach("è«‹æå¯«ä¸€æ¬¡ã€‚");
}

btnClearQuizTrace.onclick=()=>quizPad.reset();

function commitQuizScoreAndAdvance(){
  // ğŸš¦ ç´€éŒ„æœ¬é¡Œçµæœåˆ°äº¤é€šè™ŸèªŒ
  if(!quizQCounted){
    quizResults.push(true);
  }else if(quizQWrong){
    quizResults.push(false);
  }
  renderQuizLights();
  // âœ… åªæœ‰åœ¨ã€Œæå¯«é€šéã€æ™‚ï¼Œæ‰è¦–ç‚ºæœ¬é¡ŒçµæŸä¸¦å‰é€²
  // - è‹¥æœ¬é¡Œæ›¾ç­”éŒ¯ï¼štotal å·²åœ¨ç­”éŒ¯æ™‚ +1ï¼Œé€™è£¡ä¸å†åŠ ï¼›correct ä¸åŠ 
  // - è‹¥æœ¬é¡Œæœªç­”éŒ¯ï¼šæ­¤æ™‚æ‰è¨ˆç‚ºç­”å°ï¼ˆtotal+1, correct+1ï¼‰
  if(!quizQCounted){
    levelTotal++;
    levelCorrect++;
    quizQCounted=true;
  }

  // é”åˆ°é¡Œæ•¸é–€æª»å¾Œç«‹å³çµç®—æœ¬é—œï¼ˆä¸çµ¦ä¸‹ä¸€é¡ŒæŒ‰éˆ•ï¼‰
  if(levelTotal>=settings.requiredQuestions){
    const acc=percent(levelCorrect, levelTotal);
    const pass = (acc>=settings.requiredAccuracy);

    if(pass){
      speakCoach("ä½ é€šéäº†!");
      // ç´¯ç©æœ¬æ©Ÿï¼ˆå¯åšæˆå°±ï¼‰
      stats.correct = (stats.correct||0) + levelCorrect;
      stats.total = (stats.total||0) + levelTotal;
      saveJSON(K_STATS, stats);

      // é€²ä¸‹ä¸€é—œ
      levelIndex++;
      const pool=enabledPool();
      if(levelIndex>=pool.length){
        // å…¨é€šé—œï¼šè‹¥æœ‰ç­ç´šåº§è™Ÿå‰‡å›å‚³
        speakCoach("ä½ é€šéäº†!");
        tryPostFinal();
        resetQuizUI();
        return;
      }

      // reset level
      levelCorrect=0; levelTotal=0;
      setTimeout(()=>nextQuestion(), 250);
      return;
    }

    // æœªé€šéï¼šé‡åšæœ¬é—œï¼ˆä¸æ’­ã€Œæœªé€šéã€èªéŸ³ï¼Œåªé‡ç½®ï¼‰
    levelCorrect=0; levelTotal=0;
    setTimeout(()=>nextQuestion(), 250);
    return;
  }

  // é‚„æ²’åˆ°é¡Œæ•¸ï¼šç›´æ¥ä¸‹ä¸€é¡Œ
  setTimeout(()=>nextQuestion(), 180);
}

btnGradeQuizTrace.onclick=()=>{
  if(!quizNeedTrace || !quizChosenOk) return;
  const r=quizPad.computePass();
  if(r.pass){
    quizTraceResult.className="resultText ok";
    quizTraceResult.textContent="âœ… é€šé";
    speakCoach("ä½ é€šéäº†!");
    commitQuizScoreAndAdvance();
  }else{
    quizTraceResult.className="resultText bad";
    quizTraceResult.textContent="âŒ æœªé€šé";
    // âŒ æ¸¬é©—æ¨¡å¼ä¸æ’­ã€Œæœªé€šéï¼Œå†è©¦è©¦çœ‹ã€èªéŸ³ï¼ˆåªç”¨é¡è‰²æç¤ºï¼‰
    // ä¸ç®—å®Œæˆï¼Œç•™åœ¨æå¯«éšæ®µ
  }
};

btnReplayQuiz.onclick=()=>{ if(quizRunning) speakBopomofo(quizGoal); };
btnResetQuiz.onclick=()=>{ startQuiz(); };
btnStartQuiz.onclick=startQuiz;

async function tryPostFinal(){
  const sid = computedStudentId();
  if(!sid) return; // âœ… æ²’é¸ç­ç´šåº§è™Ÿï¼šä¸å›å‚³

  const payload={
    type:"bopomofo_quiz_result",
    timestamp: nowIso(),
    deviceId: getDeviceId(),
    student:{ id:sid, classNo: student.classNo||"", seatNo: student.seatNo||"", name: student.name||"" },
    settings:{
      requiredQuestions: settings.requiredQuestions,
      requiredAccuracy: settings.requiredAccuracy,
      enabledSymbols: enabledPool(),
      mode:"quiz_trace_gate"
    },
    summary:{
      clearedLevels: enabledPool().length,
      totalLevels: enabledPool().length,
    }
  };
  await postResult(payload);
}

/** ====== INIT ====== **/
function renderQuizLights(){
  quizLights.innerHTML="";
  const total=settings.requiredQuestions;
  for(let i=0;i<total;i++){
    const d=document.createElement("div");
    d.style.width="18px";
    d.style.height="18px";
    d.style.borderRadius="50%";
    d.style.background = quizResults[i]===true ? "#22c55e" : quizResults[i]===false ? "#ef4444" : "#94a3b8";
    quizLights.appendChild(d);
  }
}

(function init(){
  // theme
  setTheme(loadTheme());
  themeBtn.onclick=()=>setTheme(document.documentElement.dataset.theme==="dark"?"light":"dark");

  // voices might load later
  if(window.speechSynthesis){
    pickVoice();
    window.speechSynthesis.onvoiceschanged=()=>pickVoice();
  }

  // student
  updateStudentHint();

  // learn
  renderSymbolButtons();
  learnPad.reset();

  // teacher
  renderTeacherSymbols();
  updateTeacherMeta();

  // quiz
  resetQuizUI();

  // default tab
  setTab("learn");
})();
</script>
</body>
</html>
